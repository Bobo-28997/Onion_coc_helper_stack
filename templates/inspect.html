{% extends "base.html" %}

{% block title %}æ£€éªŒ: {{ inv.name }}{% endblock %}

{% block css %}
<style>
    /* æ¨¡ä»¿ create.html çš„æ ·å¼ï¼Œä½†åšå¾®è°ƒ */
    .stat-box { background: white; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem; text-align: center; position: relative; }
    
    /* æ·éª°æŒ‰é’®æ ·å¼ï¼šçœ‹èµ·æ¥åƒæ ‡ç­¾ï¼Œä½†é¼ æ ‡æ‚¬åœä¼šå˜è‰² */
    .roll-btn {
        cursor: pointer;
        display: block;
        font-size: 0.75rem;
        color: #6c757d;
        background: none;
        border: none;
        width: 100%;
        transition: color 0.2s, font-weight 0.2s;
    }
    .roll-btn:hover {
        color: #0d6efd; /* è“è‰² */
        font-weight: bold;
        text-decoration: underline;
    }

    /* ç»“æœæ˜¾ç¤ºåŒºï¼šå›ºå®šåœ¨å³ä¸‹è§’ */
    #dice-result-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        width: 300px;
    }
    
    /* åªè¯»æ•°å€¼çš„æ ·å¼ */
    .readonly-val {
        font-weight: bold;
        font-size: 1.1em;
        padding-top: 4px;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ” è°ƒæŸ¥å‘˜é¢æ¿: {{ inv.name }}</h2>
            <div>
                <a href="/investigators/export_json/{{ inv.id }}" class="btn btn-outline-info btn-sm me-2">
                    <i class="fas fa-file-export"></i> å¯¼å‡ºJSONè§’è‰²å¡
                </a>
                <a href="/" class="btn btn-outline-secondary btn-sm">è¿”å›åˆ—è¡¨</a>
            </div>
        </div>

        <div id="dice-result-container"></div>

        <form action="/investigators/save_status" method="post">
            <input type="hidden" name="id" value="{{ inv.id }}">

            <div class="card mb-4 shadow border-primary">
                <div class="card-header bg-primary text-white"><i class="fas fa-heartbeat"></i> æ ¸å¿ƒçŠ¶æ€ (å¯ç¼–è¾‘)</div>
                <div class="card-body">
                    <div class="row g-2 justify-content-center">
                        {% macro status_input(label, name, value, max_val=None) %}
                        <div class="col-4 col-md-2">
                            <div class="stat-box shadow-sm">
                                <label class="d-block small text-muted mb-1">{{ label }}</label>
                                <input type="number" class="form-control text-center fw-bold fs-5 text-primary" 
                                       name="{{ name }}" value="{{ value }}">
                                {% if max_val %}
                                <div class="small text-muted mt-1">/ {{ max_val }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endmacro %}

                        {{ status_input('ç”Ÿå‘½ HP', 'hp_current', inv.hp_current, inv.hp_max) }}
                        {{ status_input('é­”æ³• MP', 'mp_current', inv.mp_current, inv.mp_max) }}
                        <div class="col-4 col-md-2">
                            <div class="stat-box shadow-sm">
                                <button type="button" class="roll-btn"
                                        hx-post="/investigators/roll_check"
                                        hx-vals='{"skill_name": "ç†æ™ºæ£€å®š(SC)", "skill_val": {{ inv.san_current }}}'
                                        hx-target="#dice-result-container">
                                    <i class="fas fa-brain"></i> ç†æ™º SAN
                                </button>

                                <input type="number" class="form-control text-center fw-bold fs-5 text-primary"
                                        name="san_current" value="{{ inv.san_current }}">

                                <div class="small text-muted mt-1">
                                    / {{ 99 - inv.cthulhu_mythos }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-4 col-md-2">
                             <div class="stat-box">
                                <button type="button" class="roll-btn"
                                    hx-post="/investigators/roll_check"
                                    hx-vals='{"skill_name": "å¹¸è¿", "skill_val": {{ inv.luck_stat }}}'
                                    hx-target="#dice-result-container">
                                    <i class="fas fa-dice-d20"></i> å¹¸è¿
                                </button>
                                <input type="number" class="form-control text-center fw-bold" 
                                       name="luck_stat" value="{{ inv.luck_stat }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header"><i class="fas fa-chart-bar"></i> å±æ€§æ£€å®š (ç‚¹å‡»åç§°æŠ•éª°)</div>
                        <div class="card-body">
                            <div class="row g-2">
                                {% macro stat_roll(label, val, char_name) %}
                                <div class="col-3 col-md-2">
                                    <div class="stat-box bg-light">
                                        <button type="button" class="roll-btn"
                                                hx-post="/investigators/roll_check"
                                                hx-vals='{"skill_name": "{{ label }}", "skill_val": {{ val }}, "inv_name": "{{ char_name }}"}'
                                                hx-target="#dice-result-container">
                                            {{ label }}
                                        </button>
                                        <span class="readonly-val">{{ val }}</span>
                                    </div>
                                </div>
                                {% endmacro %}

                                {{ stat_roll('åŠ›é‡', inv.str_stat, inv.name) }}
                                {{ stat_roll('æ•æ·', inv.dex_stat, inv.name) }}
                                {{ stat_roll('æ„å¿—', inv.pow_stat, inv.name) }}
                                {{ stat_roll('ä½“è´¨', inv.con_stat, inv.name) }}
                                {{ stat_roll('å¤–è²Œ', inv.app_stat, inv.name) }}
                                {{ stat_roll('ä½“å‹', inv.siz_stat, inv.name) }}
                                {{ stat_roll('æ™ºåŠ›', inv.int_stat, inv.name) }}
                                {{ stat_roll('æ•™è‚²', inv.edu_stat, inv.name) }}
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header"><i class="fas fa-book"></i> æŠ€èƒ½æ£€å®š</div>
                        <div class="card-body">
                            <div class="row g-2">
                                {% macro skill_roll(label, val, char_name) %}
                                    {% if val and val > 0 %} <div class="col-4 col-md-3">
                                        <div class="stat-box">
                                            <button type="button" class="roll-btn"
                                                    hx-post="/investigators/roll_check"
                                                    hx-vals='{"skill_name": "{{ label }}", "skill_val": {{ val }}, "char_name": "{{ inv.name }}"}'
                                                    hx-target="#dice-result-container">
                                                {{ label }}
                                            </button>
                                            <span class="readonly-val">{{ val }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endmacro %}

                                {{ skill_roll('ä¿¡ç”¨', inv.credit_rating, inv.name) }}
                                {{ skill_roll('ä¾¦å¯Ÿ', inv.spot_hidden, inv.name) }}
                                {{ skill_roll('è†å¬', inv.listen, inv.name) }}
                                {{ skill_roll('å›¾ä¹¦é¦†', inv.library_use, inv.name) }}
                                {{ skill_roll('æ€¥æ•‘', inv.first_aid, inv.name) }}
                                {{ skill_roll('å¿ƒç†å­¦', inv.psychology, inv.name) }}
                                {{ skill_roll('åŒ»å­¦', inv.medicine, inv.name) }}
                                {{ skill_roll('ç²¾ç¥åˆ†æ', inv.psychoanalysis, inv.name) }}
                                {{ skill_roll('å–æ‚¦', inv.charm, inv.name) }}
                                {{ skill_roll('è¯æœ¯', inv.fast_talk, inv.name) }}
                                {{ skill_roll('è¯´æœ', inv.persuade, inv.name) }}
                                {{ skill_roll('æå“', inv.intimidate, inv.name) }}
                                {{ skill_roll('æ–—æ®´', inv.fighting_brawl, inv.name) }}
                                {{ skill_roll('é—ªé¿', inv.dodge, inv.name) }}
                                {{ skill_roll('å°„å‡»:æ‰‹æª', inv.firearms_handgun, inv.name) }}
                                {{ skill_roll('æŠ•æ·', inv.throw, inv.name) }}
                                {% if inv.fighting_b_name %}{{ skill_roll(inv.fighting_b_name, inv.fighting_b_val, inv.name) }}{% endif %}
                                {% if inv.fighting_c_name %}{{ skill_roll(inv.fighting_c_name, inv.fighting_c_val, inv.name) }}{% endif %}
                                {{ skill_roll('å°„å‡»:æ­¥æª', inv.firearms_rifle) }}
                                {% if inv.firearms_c_name %}{{ skill_roll(inv.firearms_c_name, inv.firearms_c_val, inv.name) }}{% endif %}
                                {{ skill_roll('å…‹è‹é²ç¥è¯', inv.cthulhu_mythos, inv.name) }}
                                {{ skill_roll('ä¼šè®¡', inv.accounting, inv.name) }}
                                {{ skill_roll('ä¼°ä»·', inv.appraise, inv.name) }}
                                {{ skill_roll('è€ƒå¤å­¦', inv.archaeology, inv.name) }}
                                {{ skill_roll('äººç±»å­¦', inv.anthropology, inv.name) }}
                                {{ skill_roll('æ³•å¾‹', inv.law, inv.name) }}
                                {{ skill_roll('å†å²', inv.history, inv.name) }}
                                {{ skill_roll('ç¥ç§˜å­¦', inv.occult, inv.name) }}
                                {{ skill_roll('åšç‰©å­¦', inv.natural_world, inv.name) }}
                                {% if inv.science_a_name %}{{ skill_roll(inv.science_a_name, inv.science_a_val, inv.name) }}{% endif %}
                                {% if inv.science_b_name %}{{ skill_roll(inv.science_b_name, inv.science_b_val, inv.name) }}{% endif %}
                                {% if inv.science_c_name %}{{ skill_roll(inv.science_c_name, inv.science_c_val, inv.name) }}{% endif %}
                                {{ skill_roll('éª‘æœ¯', inv.ride, inv.name) }}
                                {{ skill_roll('æ±½è½¦é©¾é©¶', inv.drive_auto, inv.name) }}
                                {% if inv.drive_a_name %}{{ skill_roll(inv.drive_a_name, inv.drive_a_val, inv.name) }}{% endif %}
                                {{ skill_roll('é”åŒ ', inv.locksmith, inv.name) }}
                                {{ skill_roll('æœºæ¢°ç»´ä¿®', inv.mech_repair, inv.name) }}
                                {{ skill_roll('ç”µæ°”ç»´ä¿®', inv.elec_repair, inv.name) }}
                                {{ skill_roll('æ”€çˆ¬', inv.climb, inv.name) }}
                                {{ skill_roll('è·³è·ƒ', inv.jump, inv.name) }}
                                {{ skill_roll('æ¸¸æ³³', inv.swim, inv.name) }}
                                {{ skill_roll('æ½œè¡Œ', inv.stealth, inv.name) }}
                                {{ skill_roll('è¿½è¸ª', inv.track, inv.name) }}
                                {{ skill_roll('å¿«æ‰‹', inv.sleight_of_hand, inv.name) }}
                                {{ skill_roll('ä¹”è£…', inv.disguise, inv.name) }}
                                {{ skill_roll('å¯¼èˆª', inv.navigate, inv.name) }}
                                {{ skill_roll('ç”Ÿå­˜', inv.survival, inv.name) }}
                                {{ skill_roll('æ¯è¯­', inv.language, inv.name) }}
                                {% if inv.language_b_name %}{{ skill_roll(inv.language_b_name, inv.language_b_val, inv.name) }}{% endif %}
                                {% if inv.language_c_name %}{{ skill_roll(inv.language_c_name, inv.language_c_val, inv.name) }}{% endif %}
                                {% if inv.craft_a_name %}{{ skill_roll(inv.craft_a_name, inv.craft_a_val, inv.name) }}{% endif %}
                                {% if inv.craft_b_name %}{{ skill_roll(inv.craft_b_name, inv.craft_b_val, inv.name) }}{% endif %}

                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    
                    <div class="card mb-3 shadow-sm border-danger">
                        <div class="card-header bg-danger text-white"><i class="fas fa-skull"></i> æ­¦å™¨ä¸ä¼¤å®³ (å¯ç¼–è¾‘)</div>
                        <div class="card-body p-2">
                            <div class="alert alert-light p-1 mb-2 small text-center">
                                DB: <strong>{{ inv.db_val }}</strong> | 
                                Build: <strong>{{ inv.build_val if inv.build_val else 0 }}</strong>
                            </div>
                            
                            <div class="mb-2">
                                <label class="small text-muted">æ–—æ®´ ({{ inv.fighting_brawl }})</label>
                                <input type="text" class="form-control form-control-sm" 
                                       name="fighting_damage_a" value="{{ inv.fighting_damage_a }}" placeholder="ä¼¤å®³å…¬å¼">
                            </div>
                            {% if inv.fighting_b_name %}
                            <div class="mb-2">
                                <label class="small text-muted">{{ inv.fighting_b_name }} ({{ inv.fighting_b_val }})</label>
                                <input type="text" class="form-control form-control-sm"
                                    name="fighting_damage_b" value="{{ inv.fighting_damage_b }}" placeholder="ä¼¤å®³å…¬å¼">
                            </div>
                            {% endif %}
                            {% if inv.fighting_c_name %}
                            <div class="mb-2">
                                <label class="small text-muted">{{ inv.fighting_c_name }} ({{ inv.fighting_c_val }})</label>
                                <input type="text" class="form-control form-control-sm"
                                    name="fighting_damage_c" value="{{ inv.fighting_damage_c }}" placeholder="ä¼¤å®³å…¬å¼">
                            </div>
                            {% endif %}
                             <div class="mb-2">
                                <label class="small text-muted">æ‰‹æª ({{ inv.firearms_handgun }})</label>
                                <input type="text" class="form-control form-control-sm" 
                                       name="firearms_damage_a" value="{{ inv.firearms_damage_a }}" placeholder="ä¼¤å®³å…¬å¼">
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted">æ­¥æª ({{ inv.firearms_rifle }})</label>
                                <input type="text" class="form-control form-control-sm"
                                       name="firearms_damage_b" value="{{ inv.firearms_damage_b }}" placeholder="ä¼¤å®³å…¬å¼">
                            </div>
                            {% if inv.firearms_c_name %}
                            <div class="mb-2">
                                <label class="small text-muted">{{ inv.firearms_c_name }} ({{ inv.firearms_c_val }})</label>
                                <input type="text" class="form-control form-control-sm"
                                    name="firearms_damage_c" value="{{ inv.firearms_damage_c }}" placeholder="ä¼¤å®³å…¬å¼">
                            </div>
                            {% endif %}
                            </div>
                    </div>

                    <div class="card mb-3 shadow-sm border-info">
                        <div class="card-header bg-info text-white text-center py-1 small">
                            <i class="fas fa-dice-d6"></i> è‡ªå®šä¹‰éª°å­ (1dX)
                        </div>
                        <div class="card-body p-2">
                            <div class="row g-1 align-items-center">

                                <div class="col-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text px-1 text-muted">d</span>
                                        <input type="number" class="form-control text-center fw-bold"
                                               id="custom_dice_sides"
                                               name="sides"
                                               value="6" min="1" placeholder="é¢">
                                        <input type="hidden" name="inv_name" value="{{ inv.name }}" id="hidden_inv_name">
                                    </div>
                                </div>

                                <div class="col-4">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-dark w-100"
                                            hx-post="/investigators/roll_custom"
                                            hx-target="#custom-dice-output"
                                            hx-include="#custom_dice_sides, #hidden_inv_name">
                                        <i class="fas fa-random"></i> æŠ•æ·
                                    </button>
                                </div>

                                <div class="col-4">
                                    <div id="custom-dice-output"
                                         class="form-control form-control-sm text-center fw-bold text-danger bg-light"
                                         style="min-height: 31px;">
                                        -
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header"><i class="fas fa-box-open"></i> éšèº«ç‰©å“ (å¯ç¼–è¾‘)</div>
                        <div class="card-body p-2 row g-2">
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_1" value="{{ inv.item_1 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_2" value="{{ inv.item_2 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_3" value="{{ inv.item_3 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_4" value="{{ inv.item_4 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_5" value="{{ inv.item_5 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_6" value="{{ inv.item_6 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_7" value="{{ inv.item_7 }}"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="item_8" value="{{ inv.item_8 }}"></div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 sticky-top" style="top: 20px; z-index: 100;">
                        <button type="submit" class="btn btn-success btn-lg shadow">
                            <i class="fas fa-save"></i> æ›´æ–°çŠ¶æ€
                        </button>
                        <div class="text-center small text-muted">ç‚¹å‡»æ›´æ–°ååˆ·æ–°é¡µé¢</div>
                    </div>

                </div>
            </div>

            {% if inv.spells_text_1 or inv.spells_text_2 or inv.spells_text_3 or inv.spells_text_4 %}
            <div class="card mt-2 mb-2">
                <div class="card-header">
                    <i class="fas fa-magic"></i> æŒæ¡æ³•æœ¯
                </div>
                <div class="card-body small">
                    {% if inv.spells_text_1 %}
                    <strong>æ³•æœ¯1:</strong>{{ inv.spells_text_1 }}
                    {% endif %}

                    {% if inv.spells_text_2 %}
                    <strong>æ³•æœ¯2:</strong>{{ inv.spells_text_2 }}
                    {% endif %}

                    {% if inv.spells_text_3 %}
                    <strong>æ³•æœ¯3:</strong>{{ inv.spells_text_3 }}
                    {% endif %}

                    {% if inv.spells_text_4 %}
                    <strong>æ³•æœ¯4:</strong>{{ inv.spells_text_4 }}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="card mt-3 mb-4 text-muted">
                <div class="card-header">èƒŒæ™¯æ‘˜è¦</div>
                <div class="card-body small">
                   <p><strong>å½¢è±¡:</strong> {{ inv.description }}</p>
                   <p><strong>ç‰¹è´¨:</strong> {{ inv.traits }}</p>
                </div>
            </div>

        </form>
    </div>
</div>
{% endblock %}